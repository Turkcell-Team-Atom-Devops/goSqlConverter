CREATE VIEW [NEMS_YAP].[V_WF_STEP_HISTORY_FORORGINALSTEPS] (
    StepId,
    InstanceId,
    WfDefinitionId,
    WfDefinitionCd,
    StepDefCd,
    StatusCd,
    StepStatusDescription,
    ActionReason,
    [Description],
    StartTime,
    TakenTime,
    EndTime,
    NTUsername,
    FullName,
    PoolName,
    PoolFullName,
    PartyTypeCode
) AS
SELECT
    step.StepId,
    step.InstanceId,
    step.WfDefinitionId,
    step.WfDefinitionCd,
    step.StepDefCd,
    step.StatusCd,
    stepStatus.Description AS StepStatusDescription,
    step.ActionReason,
    step.Description,
    step.StartTime,
    step.TakenTime,
    step.EndTime,
    usr.NTUsername,
    ISNULL(usr.DisplayName, usr.NAME + ' ' + usr.SURNAME) AS FullName,
    CASE
        WHEN usr2.NTUsername IS NOT NULL THEN usr2.NTUsername
        ELSE prty.Description
    END AS PoolName,
    CASE
        WHEN usr2.NTUsername IS NOT NULL THEN usr2.DisplayName
        ELSE prty.Description
    END AS PoolFullName,
    prty.TypeCd as PartyTypeCode
FROM
    [Elysion_Kurulum].dbo.T_WF_STEP AS step WITH (NOLOCK)
    INNER JOIN [Elysion_Kurulum].dbo.T_WF_STEPSTATUS AS stepStatus WITH (NOLOCK) ON stepStatus.Code = step.StatusCd
    and step.StepDefCd not like '%_DataRequest'
    and step.StatusCd <> 'DR'
    and step.TypeCd <> 'Transfer'
    LEFT JOIN [Elysion_Kurulum].dbo.T_ORG_USER AS usr WITH (NOLOCK) ON step.UserId = usr.PartyId
    LEFT JOIN [Elysion_Kurulum].dbo.T_ORG_USER AS usr2 WITH (NOLOCK) ON step.PoolPartyId = usr2.PartyId
    LEFT JOIN [Elysion_Kurulum].dbo.T_ORG_PARTY AS prty WITH (NOLOCK) ON step.PoolPartyId = prty.PartyId